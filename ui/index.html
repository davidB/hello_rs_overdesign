<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>hello.rs overdesign</title>

    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="css/material.blue_grey-orange.min.css">
    <script defer src="css/material.min.js"></script>

    <!-- see https://vega.github.io/vega/usage/ -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega@4.0.0"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/d3@5.5.0"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega@4.0.0-rc.3"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega-lite@2.6.0"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega-embed@3.16.0"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega@3"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/vega-lite@2"></script> -->
<!-- <script src="https://cdn.jsdelivr.net/npm/vega-embed@3"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega@4.0.0/build/vega-core.min.js"></script> -->
    <script src="js/d3-5.5.0.min.js"></script>
    <script src="js/vega-4.0.0.min.js"></script>
    <script src="js/vega-lite-2.6.0.min.js"></script>
    <script src="js/vega-embed-3.16.0.min.js"></script>

    <!--script src="https://raw.githubusercontent.com/google/diff-match-patch/master/javascript/diff_match_patch.js"></script-->
    <script src="js/diff_match_patch.min.js"></script>
    <style>
        @import url(https://cdn.rawgit.com/tonsky/FiraCode/1.205/distr/fira_code.css);
        .text {
            white-space: pre;
            font-family: 'Fira Code', 'Courier New', Courier, monospace;
            font-weight: bold;
            color:rgba(10, 10, 10, 0.4);
            font-size: 1.6em;
            font-feature-settings: "calt" 1;
        }
        .text_deleted {
            color:rgba(245, 181, 181, 1.0);
            font-size: 0;
            white-space: nowrap;
            transition: font-size 2s;/*, background-color 5s; */
        }
        .text_added {
            color:rgb(52, 138, 132);
        }
        btn.selected {
            background-color: rgb(252, 178, 252)
        }
    </style>
</head>
<body>
    <!-- Uses a header that scrolls with the text, rather than staying
  locked at the top -->
    <div class="mdl-layout mdl-js-layout">
        <header class="mdl-layout__header mdl-layout__header--scroll">
          <div class="mdl-layout__header-row">
            <!-- Title -->
            <span class="mdl-layout-title">hello.rs overdesign</span>
            <!-- Add spacer, to align navigation to the right -->
            <div class="mdl-layout-spacer"></div>
            <!-- Navigation -->
            <nav class="mdl-navigation" id="samples">
            </nav>
          </div>
        </header>
        <div class="mdl-layout__drawer">
          <span class="mdl-layout-title">Files</span>
          <nav class="mdl-navigation" id="files">
          </nav>
        </div>
        <main class="mdl-layout__content">
          <!-- <div class="page-content"> -->
                        <div class="mdl-grid">
                                <div id="fileselector" class="mdl-cell mdl-cell--12-col"></div>
                                <div id="text" class="mdl-cell mdl-cell--12-col"></div>
                </div>

          </div>
        </main>
      </div>
    <h1></h1>
    <script type="text/javascript">
        var active_sample = {
            sample: "",
            filepath: "src/main.rs",
            text_raw: ""
        };
        function change_text_raw(text_raw_next) {
            var dmp = new diff_match_patch();
            var diff = dmp.diff_main(active_sample.text_raw, text_raw_next);
            // Result: [(-1, "Hell"), (1, "G"), (0, "o"), (1, "odbye"), (0, " World.")]
            dmp.diff_cleanupSemantic(diff);
            // Result: [(-1, "Hello"), (1, "Goodbye"), (0, " World.")]
            console.log(active_sample.text_raw + " --> " + diff);
            active_sample.text_raw = text_raw_next;
            var selectText = d3.select("#text").selectAll("span").data(diff);
            console.log("selectText", selectText);
            selectText
                .classed('text_deleted', function(d){ return d["0"] == -1;})
                .classed('text_added', function(d){ return d["0"] == 1;})
                .text(function(d) { return d["1"] });
            //selectText;
            //TODO componentHandler.upgradeElement(el); to notify MDL
            selectText
            .enter()
                .append("span")
                .classed('text', true)
                .classed('text_deleted', function(d){ return d["0"] == -1;})
                .classed('text_added', function(d){ return d["0"] == 1;})
                .text(function(d) { return d["1"] })
                ;
            selectText
            .exit()
            .remove()
            ;
            // var transition = d3.transition()
            // //.delay(2000)
            // .duration(1000).ease(d3.easeCubicIn)
            // ;
            // d3.selectAll(".text_added")
            // .transition(transition)
            // //.classed('text_added', false)
            // //.style('color', 'inherit')
            // .style('color', 'rgba(0,0,0,1.0)')
            // ;
            // d3.selectAll(".text_deleted")
            // .transition(transition)
            // .delay(2000)
            // .style('font-size',  '0px')
            // ;

            console.log("change_text_raw DONE");
        }
        function showSamplesSelector(data_all) {
            var data = data_all.map(function(v) { return v.folder});
            var selectSamples = d3.select("#samples").selectAll("a").data(data);
            selectSamples.enter().append("a")
            .classed("mdl-navigation__link", true)
            //.classed("sample", true)
            .text(function(d) { return d })
            .on("click", function(d, i) {
                active_sample.sample = d;
                loadActiveSample();
            });
            selectSamples.classed("selected", function(d) {
                console.log(d == active_sample.sample, d, active_sample.sample);
                return d == active_sample.sample;
            });

        }
        function showFileSelector(data_all) {
            var data = Array.from(data_all.reduce(function(acc, v) {
                 for (i of v.files) {acc.add(i)};
                 return acc
            }, new Set()));
            console.log("files", data);
            var selectSamples = d3.select("#files").selectAll("a").data(data);
            selectSamples.enter().append("a")
            .classed("mdl-navigation__link", true)
            .text(function(d) { return d })
            .on("click", function(d, i) {
                active_sample.filepath = d;
                loadActiveSample();
            });
            selectSamples.classed("selected", function(d) {
                console.log(d == active_sample.sample, d, active_sample.filepath);
                return d == active_sample.filepath;
            });

        }
        function loadActiveSample() {
            d3.text("samples/" + active_sample.sample + "/" + active_sample.filepath).then(function(text_raw_next) {
                location.hash = active_sample.sample + "/" + active_sample.filepath;
                change_text_raw(text_raw_next);
            });
        }
        d3.json("samples.index.json").then(function(data) {
            console.log(data);
            showSamplesSelector(data);
            showFileSelector(data);
            var hashValue = location.hash;
            hashValue = hashValue.replace(/^#/, '');
            var splitId = hashValue.indexOf("/");
            if (splitId > 1) {
                active_sample.sample = hashValue.substr(0, splitId);
                active_sample.filepath = hashValue.substr(splitId + 1);
                loadActiveSample();
            }
        });
        console.log("start loading");
    </script>
    <script type="text/javascript">
        var spec = "samples-selector.vg.json";
        // More argument info at https://github.com/vega/vega-embed
        vegaEmbed('#fileselector', spec).then(function(result) {
          // Access the Vega view instance (https://vega.github.io/vega/docs/api/view/) as result.view
          window.vega_result = result;
          console.log(window.vega_result);
        }).catch(console.error);
      </script>
</body>
</html>
