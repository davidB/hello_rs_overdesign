<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>hello.rs overdesign</title>

    <!-- Material Design-Lite (Hosted) -->
    <!--
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    -->
    <!-- see https://vega.github.io/vega/usage/ -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/vega@4.0.0"></script> -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/d3@5.5.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/vega@4.0.0/build/vega-core.min.js"></script> -->
    <script src="js/d3-5.5.0.min.js"></script>
    <!-- <script src="js/vega-core-4.0.0.min.js"></script> -->

    <!--script src="https://raw.githubusercontent.com/google/diff-match-patch/master/javascript/diff_match_patch.js"></script-->
    <script src="js/diff_match_patch.min.js"></script>
    <style>
        .text {
            white-space: pre;
            font-family: 'Courier New', Courier, monospace;
            color:rgba(10, 10, 10, 0.5);
            /* font-size: 1em; */
        }
        .text_deleted {
            color:rgba(245, 181, 181, 1.0);
            font-size: 0;
            white-space: nowrap;
            transition: font-size 2s;/*, background-color 5s; */
        }
        .text_added {
            color:rgb(52, 138, 132);
        }
        btn.selected {
            background-color: rgb(252, 178, 252)
        }
    </style>
</head>
<body>
    <h1>hello.rs overdesign</h1>
    <div id="samples"></div>
    <div id="files"></div>
    <div id="text"></div>
    <script>
        var active_sample = {
            sample: "",
            filepath: "src/main.rs",
            text_raw: ""
        };
        function change_text_raw(text_raw_next) {
            var dmp = new diff_match_patch();
            var diff = dmp.diff_main(active_sample.text_raw, text_raw_next);
            // Result: [(-1, "Hell"), (1, "G"), (0, "o"), (1, "odbye"), (0, " World.")]
            dmp.diff_cleanupSemantic(diff);
            // Result: [(-1, "Hello"), (1, "Goodbye"), (0, " World.")]
            console.log(active_sample.text_raw + " --> " + diff);
            active_sample.text_raw = text_raw_next;
            var selectText = d3.select("#text").selectAll("span").data(diff);
            console.log("selectText", selectText);
            selectText
                .classed('text_deleted', function(d){ return d["0"] == -1;})
                .classed('text_added', function(d){ return d["0"] == 1;})
                .text(function(d) { return d["1"] });
            //selectText;
            selectText
            .enter()
                .append("span")
                .classed('text', true)
                .classed('text_deleted', function(d){ return d["0"] == -1;})
                .classed('text_added', function(d){ return d["0"] == 1;})
                .text(function(d) { return d["1"] })
                ;
            selectText
            .exit()
            .remove()
            ;
            // var transition = d3.transition()
            // //.delay(2000)
            // .duration(1000).ease(d3.easeCubicIn)
            // ;
            // d3.selectAll(".text_added")
            // .transition(transition)
            // //.classed('text_added', false)
            // //.style('color', 'inherit')
            // .style('color', 'rgba(0,0,0,1.0)')
            // ;
            // d3.selectAll(".text_deleted")
            // .transition(transition)
            // .delay(2000)
            // .style('font-size',  '0px')
            // ;

            console.log("change_text_raw DONE");
        }
        function showSamplesSelector(data_all) {
            var data = data_all.map(function(v) { return v.folder});
            var selectSamples = d3.select("#samples").selectAll("button").data(data);
            selectSamples.enter().append("button")
            .classed("btn", true)
            .classed("sample", true)
            .text(function(d) { return d })
            .on("click", function(d, i) {
                active_sample.sample = d;
                loadActiveSample();
            });
            selectSamples.classed("selected", function(d) {
                console.log(d == active_sample.sample, d, active_sample.sample);
                return d == active_sample.sample;
            });

        }
        function showFileSelector(data_all) {
            var data = Array.from(data_all.reduce(function(acc, v) {
                 for (i of v.files) {acc.add(i)}; 
                 return acc
            }, new Set()));
            console.log("files", data);
            var selectSamples = d3.select("#files").selectAll("button").data(data);
            selectSamples.enter().append("button")
            .classed("btn", true)
            .classed("file", true)
            .text(function(d) { return d })
            .on("click", function(d, i) {
                active_sample.filepath = d;
                loadActiveSample();
            });
            selectSamples.classed("selected", function(d) {
                console.log(d == active_sample.sample, d, active_sample.filepath);
                return d == active_sample.filepath;
            });

        }
        function loadActiveSample() {
            d3.text("samples/" + active_sample.sample + "/" + active_sample.filepath).then(function(text_raw_next) {
                console.log(text_raw_next);
                console.log("loaded");
                change_text_raw(text_raw_next);
            });
        }
        d3.json("samples.index.json").then(function(data) {
            console.log(data);
            showSamplesSelector(data);
            showFileSelector(data);
        });
        console.log("start loading");
    </script>
    <script>
    </script>
</body>
</html>